
# إعداد قاعدة بيانات Supabase للتحكم الأبوي

## نظرة عامة

تم تفعيل ميزات **إعدادات الشبكة** و**حدود الوقت** مع التكامل الكامل مع قاعدة بيانات Supabase. جميع البيانات الآن يتم حفظها بشكل دائم في قاعدة البيانات.

## الجداول المُنشأة

### 1. network_settings (إعدادات الشبكة)
يحفظ معلومات الشبكات المحلية المحفوظة:
- `id`: معرف فريد للشبكة
- `ssid`: اسم الشبكة
- `password`: كلمة مرور الشبكة
- `security_type`: نوع الأمان (WPA2, WPA3, WEP, Open)
- `is_connected`: حالة الاتصال
- `last_connected`: آخر وقت اتصال
- `signal_strength`: قوة الإشارة
- `user_id`: معرف المستخدم (للتحكم في الوصول)

### 2. time_limits (حدود الوقت)
يحفظ حدود الوقت لكل ملف شخصي:
- `id`: معرف فريد للحد الزمني
- `profile_name`: اسم الملف الشخصي
- `enabled`: حالة التفعيل
- `daily_limit`: الحد اليومي بالساعات
- `schedule_start`: وقت البداية
- `schedule_end`: وقت النهاية
- `days`: الأيام المطبقة
- `user_id`: معرف المستخدم

### 3. usage_logs (سجلات الاستخدام)
يتتبع الاستخدام اليومي لكل ملف شخصي:
- `id`: معرف فريد للسجل
- `time_limit_id`: معرف الحد الزمني المرتبط
- `date`: التاريخ
- `hours_used`: عدد الساعات المستخدمة
- `user_id`: معرف المستخدم

## خطوات الإعداد

### الخطوة 1: تشغيل SQL Migration

1. افتح لوحة تحكم Supabase الخاصة بمشروعك
2. انتقل إلى **SQL Editor**
3. افتح ملف `supabase/migrations/create_parental_control_tables.sql`
4. انسخ محتوى الملف بالكامل
5. الصقه في SQL Editor
6. اضغط على **Run** لتنفيذ الأوامر

### الخطوة 2: التحقق من إنشاء الجداول

بعد تشغيل الـ SQL، تحقق من إنشاء الجداول:

```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('network_settings', 'time_limits', 'usage_logs');
```

يجب أن ترى الجداول الثلاثة في النتائج.

### الخطوة 3: التحقق من RLS Policies

تحقق من تفعيل Row Level Security:

```sql
SELECT tablename, policyname 
FROM pg_policies 
WHERE tablename IN ('network_settings', 'time_limits', 'usage_logs');
```

## الميزات المُفعّلة

### ✅ إعدادات الشبكة (Network Settings)

- **إضافة شبكات جديدة**: احفظ معلومات الشبكات المحلية في قاعدة البيانات
- **عرض الشبكات المحفوظة**: جميع الشبكات يتم تحميلها من Supabase
- **محاكاة الاتصال**: تحديث حالة الاتصال في قاعدة البيانات
- **حذف الشبكات**: حذف دائم من قاعدة البيانات
- **التحديث التلقائي**: البيانات تُحدّث تلقائياً عند تغيير حالة الشبكة

### ✅ حدود الوقت (Time Limits)

- **إضافة ملفات شخصية**: إنشاء حدود زمنية جديدة وحفظها في قاعدة البيانات
- **تفعيل/تعطيل الحدود**: تحديث حالة التفعيل في الوقت الفعلي
- **تتبع الاستخدام**: عرض الاستخدام اليومي من جدول usage_logs
- **حذف الملفات**: حذف دائم من قاعدة البيانات
- **جداول مخصصة**: تحديد أوقات وأيام مختلفة لكل ملف شخصي

## الأمان (Row Level Security)

جميع الجداول محمية بـ RLS Policies:

- **SELECT**: المستخدمون يمكنهم رؤية بياناتهم فقط
- **INSERT**: المستخدمون يمكنهم إضافة بيانات لحساباتهم فقط
- **UPDATE**: المستخدمون يمكنهم تحديث بياناتهم فقط
- **DELETE**: المستخدمون يمكنهم حذف بياناتهم فقط

البيانات التي لا تحتوي على `user_id` (null) متاحة للجميع للتوافق مع الاستخدام بدون تسجيل دخول.

## إضافة بيانات تجريبية (اختياري)

لإضافة بيانات تجريبية، قم بإلغاء التعليق عن الأسطر في نهاية ملف SQL:

```sql
insert into network_settings (ssid, password, security_type, is_connected, signal_strength) values
  ('Home WiFi', 'password123', 'WPA2', true, 85),
  ('Guest Network', 'guest123', 'WPA2', false, 60);

insert into time_limits (profile_name, enabled, daily_limit, schedule_start, schedule_end, days) values
  ('أحمد', true, 3, '08:00', '21:00', ARRAY['الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الأحد']),
  ('سارة', true, 2, '09:00', '20:00', ARRAY['الإثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الأحد']);
```

## استكشاف الأخطاء

### خطأ: "relation does not exist"

إذا ظهرت هذه الرسالة، فهذا يعني أن الجداول لم يتم إنشاؤها بعد. قم بتشغيل ملف SQL Migration.

### خطأ: "Connection timeout"

إذا كان هناك مشكلة في الاتصال بقاعدة البيانات:
1. تحقق من إعدادات الشبكة
2. تأكد من أن مشروع Supabase نشط
3. تحقق من صحة SUPABASE_URL و SUPABASE_KEY في ملف client.ts

### البيانات لا تظهر

1. تحقق من تفعيل RLS Policies
2. تأكد من أن المستخدم لديه الصلاحيات المناسبة
3. افحص console logs في التطبيق

## الخطوات التالية

بعد إعداد قاعدة البيانات:

1. **اختبر إضافة شبكة جديدة** في شاشة إعدادات الشبكة
2. **أنشئ ملف شخصي جديد** في شاشة حدود الوقت
3. **تحقق من البيانات** في لوحة تحكم Supabase
4. **راقب الأداء** باستخدام Supabase Logs

## ملاحظات مهمة

- ⚠️ **React Native لا يدعم**: مسح شبكات WiFi أو الاتصال بها برمجياً
- ✅ **التطبيق الحقيقي**: سيستخدم API الراوتر للإدارة الفعلية
- 🔒 **الأمان**: جميع كلمات المرور محفوظة في قاعدة البيانات (يُنصح بالتشفير في الإنتاج)
- 📊 **التتبع**: يمكن إضافة المزيد من الميزات لتتبع الاستخدام بدقة

## الدعم

إذا واجهت أي مشاكل:
1. تحقق من console logs في التطبيق
2. افحص Supabase Logs في لوحة التحكم
3. تأكد من صحة RLS Policies
4. راجع ملف SUPABASE_SETUP.md هذا

---

**تم التفعيل بنجاح! 🎉**

الآن يمكنك استخدام التطبيق مع قاعدة بيانات حقيقية.
